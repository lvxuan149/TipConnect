"use strict";(()=>{var e={};e.id=432,e.ids=[432],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5386:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>m,requestAsyncStorage:()=>c,routeModule:()=>p,serverHooks:()=>y,staticGenerationAsyncStorage:()=>_});var o={};r.r(o),r.d(o,{POST:()=>d});var n=r(5197),a=r(326),i=r(1009),s=r(4680),u=r(7312),l=r(6357);async function d(e){if(!function(e){let t=process.env.WEBHOOK_SECRET,r=e.headers.get("x-webhook-secret");return t&&r&&t===r}(e))return s.NextResponse.json({error:"unauthorized"},{status:401});let t=await e.json().catch(()=>({})),r={tx_signature:String(t.txSignature??""),type:String(t.type??""),signer:String(t.signer??""),receiver:String(t.receiver??""),amount:String(Number(t.amount??0)),story_id:t.storyId?String(t.storyId):null,timestamp:Number(t.timestamp??Date.now())};try{let e=await u.db.insert(l.U3).values(r).onConflictDoNothing(),t=Array.isArray(e)?e.length:"object"==typeof e&&null!==e?Number(e.rowsAffected??e.rowCount??0):0;return console.log(JSON.stringify({ingested:t,duplicate:0===t})),s.NextResponse.json({ok:!0,idempotent:!0})}catch(e){return console.error("ingest_error",e),s.NextResponse.json({ok:!1},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/webhooks/solana/tx/route",pathname:"/api/webhooks/solana/tx",filename:"route",bundlePath:"app/api/webhooks/solana/tx/route"},resolvedPagePath:"/Users/lvxuan/github/TipConnect/app/api/webhooks/solana/tx/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:c,staticGenerationAsyncStorage:_,serverHooks:y}=p,h="/api/webhooks/solana/tx/route";function m(){return(0,i.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:_})}},6357:(e,t,r)=>{r.d(t,{E7:()=>p,OW:()=>d,U3:()=>c,zc:()=>_});var o=r(989),n=r(7533),a=r(2582),i=r(3755),s=r(2723),u=r(8873),l=r(3836);let d=(0,o.af)("stories",{id:(0,n.L7)("id",{length:64}).primaryKey(),title:(0,a.fL)("title").notNull(),summary:(0,a.fL)("summary").default(""),host_id:(0,n.L7)("host_id",{length:64}).notNull(),created_at:(0,i.AB)("created_at",{withTimezone:!0}).defaultNow()}),p=(0,o.af)("hosts",{id:(0,n.L7)("id",{length:64}).primaryKey(),name:(0,a.fL)("name").notNull(),web2_links:(0,a.fL)("web2_links").default("[]"),created_at:(0,i.AB)("created_at",{withTimezone:!0}).defaultNow()}),c=(0,o.af)("events",{id:(0,n.L7)("id",{length:72}).primaryKey().$defaultFn(()=>crypto.randomUUID()),type:(0,n.L7)("type",{length:16}).notNull(),signer:(0,n.L7)("signer",{length:128}).notNull(),receiver:(0,n.L7)("receiver",{length:128}).notNull(),amount:(0,s.uR)("amount",{precision:18,scale:9}).default("0"),tx_signature:(0,n.L7)("tx_signature",{length:128}).notNull(),story_id:(0,n.L7)("story_id",{length:64}),timestamp:(0,u.Kv)("timestamp",{mode:"number"}).notNull()},e=>({byTxType:(0,l.o9)("uniq_tx_type").on(e.tx_signature,e.type),byStory:(0,l.Kz)("idx_story").on(e.story_id)})),_=(0,o.af)("host_metrics",{host_id:(0,n.L7)("host_id",{length:64}).primaryKey(),total_tip_value_sol:(0,s.uR)("total_tip_value_sol",{precision:18,scale:9}).default("0"),unique_supporters:(0,s.uR)("unique_supporters",{precision:10,scale:0}).default("0"),share_count:(0,s.uR)("share_count",{precision:10,scale:0}).default("0"),stories_count:(0,s.uR)("stories_count",{precision:10,scale:0}).default("0"),updated_at:(0,i.AB)("updated_at",{withTimezone:!0}).defaultNow()});(0,o.af)("story_metrics_daily",{id:(0,n.L7)("id",{length:72}).primaryKey().$defaultFn(()=>crypto.randomUUID()),story_id:(0,n.L7)("story_id",{length:64}).notNull(),date:(0,i.AB)("date",{withTimezone:!0}).notNull(),total_tip_value_sol:(0,s.uR)("total_tip_value_sol",{precision:18,scale:9}).default("0"),unique_supporters:(0,s.uR)("unique_supporters",{precision:10,scale:0}).default("0"),share_count:(0,s.uR)("share_count",{precision:10,scale:0}).default("0"),created_at:(0,i.AB)("created_at",{withTimezone:!0}).defaultNow()},e=>({byStoryDate:(0,l.o9)("uniq_story_date").on(e.story_id,e.date),byStory:(0,l.Kz)("idx_story").on(e.story_id),byDate:(0,l.Kz)("idx_date").on(e.date)}))},7312:(e,t,r)=>{r.d(t,{db:()=>u});var o=r(7136),n=r(7910);let a=process.env.DATABASE_URL||"",i=a.includes("channel_binding=")?a:a+(a.includes("?")?"&":"?")+"channel_binding=disable";if(!i)throw Error("DATABASE_URL is not set");let s=(0,n.qn)(i),u=(0,o.tS)(s)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[764,914],()=>r(5386));module.exports=o})();