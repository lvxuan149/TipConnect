(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[525],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},4304:(e,t,r)=>{"use strict";r.r(t),r.d(t,{ComponentMod:()=>v,default:()=>N});var n={};r.r(n),r.d(n,{GET:()=>m,runtime:()=>_});var i={};r.r(i),r.d(i,{originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var a=r(1409),o=r(7140),s=r(2913),l=r(4474),u=r(8144),d=r(7607),c=r(799);let _="edge";async function m(e){let t=Date.now();try{let r=new URL(e.url||"http://localhost:3000/api/discover").searchParams,n=Math.min(Number(r.get("limit")||"20"),100),i=Math.max(Number(r.get("offset")||"0"),0),a=r.get("sort")||"trending",o=Number(r.get("min_sol")||"0"),[s,l]=await Promise.all([d.db.select().from(c.OW),d.db.select().from(c.E7)]),_=new Map;for(let e of l)_.set(e.id,e);let m=s.map(e=>{let t=10*Math.random(),r=Math.floor(5*Math.random())+1,n=Math.floor(3*Math.random()),i=_.get(e.host_id);return{id:e.id,title:e.title,summary:e.summary,host:{id:i?.id||e.host_id,name:i?.name||"Unknown",avatar_url:i?.avatar_url||""},metrics:{total_sol:Number(t.toFixed(2)),supporters:r,shares:n},created_at:e.created_at,trending_score:t*(1+.1*n+.05*r)}}).filter(e=>e.metrics.total_sol>=o),h={items:[...m].sort((e,t)=>{switch(a){case"trending":default:return t.trending_score-e.trending_score;case"newest":return(t.created_at?new Date(t.created_at).getTime():0)-(e.created_at?new Date(e.created_at).getTime():0);case"total_sol":return t.metrics.total_sol-e.metrics.total_sol}}).slice(i,i+n),pagination:{limit:n,offset:i,total:m.length,has_more:i+n<m.length},meta:{processed_count:s.length,latency_ms:Date.now()-t}};return console.log("Discover API:",JSON.stringify({path:"/api/discover",query:Object.fromEntries(r),result_count:h.items.length,total_available:h.pagination.total,latency_ms:h.meta.latency_ms})),u.xk.json(h)}catch(e){return console.error("Discover API error:",e),u.xk.json({error:"Failed to fetch discover stories"},{status:500})}}let h=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/discover/route",pathname:"/api/discover",filename:"route",bundlePath:"app/api/discover/route"},resolvedPagePath:"/Users/lvxuan/github/TipConnect/app/api/discover/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:g}=h,y="/api/discover/route";function w(){return(0,l.XH)({serverHooks:g,staticGenerationAsyncStorage:f})}let v=i,N=a.a.wrap(h)},799:(e,t,r)=>{"use strict";r.d(t,{U3:()=>y,E7:()=>g,OW:()=>f});var n=r(4974),i=r(8775),a=r(5573),o=r(8047),s=r(7921),l=r(8898),u=r(5998),d=r(9457),c=r(1271);class _{constructor(e,t){this.unique=e,this.name=t}static [d.Q]="PgIndexBuilderOn";on(...e){return new m(e.map(e=>{if((0,d.is)(e,u.$s))return e;let t=new c.pK(e.name,!!e.keyAsName,e.columnType,e.indexConfig);return e.indexConfig=JSON.parse(JSON.stringify(e.defaultConfig)),t}),this.unique,!1,this.name)}onOnly(...e){return new m(e.map(e=>{if((0,d.is)(e,u.$s))return e;let t=new c.pK(e.name,!!e.keyAsName,e.columnType,e.indexConfig);return e.indexConfig=e.defaultConfig,t}),this.unique,!0,this.name)}using(e,...t){return new m(t.map(e=>{if((0,d.is)(e,u.$s))return e;let t=new c.pK(e.name,!!e.keyAsName,e.columnType,e.indexConfig);return e.indexConfig=JSON.parse(JSON.stringify(e.defaultConfig)),t}),this.unique,!0,this.name,e)}}class m{static [d.Q]="PgIndexBuilder";config;constructor(e,t,r,n,i="btree"){this.config={name:n,columns:e,unique:t,only:r,method:i}}concurrently(){return this.config.concurrently=!0,this}with(e){return this.config.with=e,this}where(e){return this.config.where=e,this}build(e){return new h(this.config,e)}}class h{static [d.Q]="PgIndex";config;constructor(e,t){this.config={...e,table:t}}}function p(e){return new _(!1,e)}let f=(0,n.af)("stories",{id:(0,i.L7)("id",{length:64}).primaryKey(),title:(0,a.fL)("title").notNull(),summary:(0,a.fL)("summary").default(""),host_id:(0,i.L7)("host_id",{length:64}).notNull(),created_at:(0,o.AB)("created_at",{withTimezone:!0}).defaultNow()}),g=(0,n.af)("hosts",{id:(0,i.L7)("id",{length:64}).primaryKey(),name:(0,a.fL)("name").notNull(),web2_links:(0,a.fL)("web2_links").default("[]"),created_at:(0,o.AB)("created_at",{withTimezone:!0}).defaultNow()}),y=(0,n.af)("events",{id:(0,i.L7)("id",{length:72}).primaryKey().$defaultFn(()=>crypto.randomUUID()),type:(0,i.L7)("type",{length:16}).notNull(),signer:(0,i.L7)("signer",{length:128}).notNull(),receiver:(0,i.L7)("receiver",{length:128}).notNull(),amount:(0,s.uR)("amount",{precision:18,scale:9}).default("0"),tx_signature:(0,i.L7)("tx_signature",{length:128}).notNull(),story_id:(0,i.L7)("story_id",{length:64}),timestamp:(0,l.Kv)("timestamp",{mode:"number"}).notNull()},e=>({byTxType:new _(!0,"uniq_tx_type").on(e.tx_signature,e.type),byStory:p("idx_story").on(e.story_id)}));(0,n.af)("host_metrics",{host_id:(0,i.L7)("host_id",{length:64}).primaryKey(),total_tip_value_sol:(0,s.uR)("total_tip_value_sol",{precision:18,scale:9}).default("0"),unique_supporters:(0,s.uR)("unique_supporters",{precision:10,scale:0}).default("0"),share_count:(0,s.uR)("share_count",{precision:10,scale:0}).default("0"),stories_count:(0,s.uR)("stories_count",{precision:10,scale:0}).default("0"),updated_at:(0,o.AB)("updated_at",{withTimezone:!0}).defaultNow()}),(0,n.af)("story_metrics_daily",{id:(0,i.L7)("id",{length:72}).primaryKey().$defaultFn(()=>crypto.randomUUID()),story_id:(0,i.L7)("story_id",{length:64}).notNull(),date:(0,o.AB)("date",{withTimezone:!0}).notNull(),total_tip_value_sol:(0,s.uR)("total_tip_value_sol",{precision:18,scale:9}).default("0"),unique_supporters:(0,s.uR)("unique_supporters",{precision:10,scale:0}).default("0"),share_count:(0,s.uR)("share_count",{precision:10,scale:0}).default("0"),created_at:(0,o.AB)("created_at",{withTimezone:!0}).defaultNow()},e=>({byStoryDate:new _(!0,"uniq_story_date").on(e.story_id,e.date),byStory:p("idx_story").on(e.story_id),byDate:p("idx_date").on(e.date)}))},7607:(e,t,r)=>{"use strict";r.d(t,{db:()=>l});var n=r(2325),i=r(1400);let a=process.env.DATABASE_URL||"",o=a.includes("channel_binding=")?a:a+(a.includes("?")?"&":"?")+"channel_binding=disable";if(!o)throw Error("DATABASE_URL is not set");let s=(0,i.qn)(o),l=(0,n.tS)(s)}},e=>{var t=t=>e(e.s=t);e.O(0,[855],()=>t(4304));var r=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/discover/route"]=r}]);
//# sourceMappingURL=route.js.map