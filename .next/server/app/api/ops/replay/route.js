"use strict";(()=>{var e={};e.id=321,e.ids=[321],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},920:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>v,patchFetch:()=>S,requestAsyncStorage:()=>m,routeModule:()=>y,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var r={};o.r(r),o.d(r,{GET:()=>g,POST:()=>c});var s=o(5197),a=o(326),n=o(1009),i=o(4680),l=o(3562),u=o(7312),d=o(6357);async function p(){let e=Date.now();try{let t=await u.db.select().from(d.E7),o=await u.db.select().from(d.OW),r=0,s=0;for(let e of t){let t=o.filter(t=>t.host_id===e.id).map(e=>e.id);if(0===t.length){await u.db.insert(d.zc).values({host_id:e.id,total_tip_value_sol:"0",unique_supporters:"0",share_count:"0",stories_count:"0",updated_at:new Date}).onConflictDoUpdate({target:d.zc.host_id,set:{total_tip_value_sol:"0",unique_supporters:"0",share_count:"0",stories_count:"0",updated_at:new Date}});continue}let s=[];t.length>0&&(s=await u.db.select().from(d.U3).where((0,l.d3)(d.U3.story_id,t)));let a=0,n=new Set,i=0;for(let e of s)"tip"===e.type?(a+=Number(e.amount||0),n.add(e.signer)):"share"===e.type&&(i+=1);await u.db.insert(d.zc).values({host_id:e.id,total_tip_value_sol:a.toString(),unique_supporters:n.size.toString(),share_count:i.toString(),stories_count:t.length.toString(),updated_at:new Date}).onConflictDoUpdate({target:d.zc.host_id,set:{total_tip_value_sol:a.toString(),unique_supporters:n.size.toString(),share_count:i.toString(),stories_count:t.length.toString(),updated_at:new Date}}),r+=t.length}let a=await u.db.select().from(d.U3),n=new Map,i=0;for(let e of a){let t=`${e.tx_signature}-${e.type}`,o=n.get(t)||0;o>0&&i++,n.set(t,o+1)}s=i;let p=Date.now()-e;return console.log(`Host metrics refreshed: ingested_total=${r}, duplicates_total=${s}, overview_latency_ms=${p}`),{ingested_total:r,duplicates_total:s,overview_latency_ms:p}}catch(t){return console.error("Error refreshing host metrics:",t),{ingested_total:0,duplicates_total:0,overview_latency_ms:Date.now()-e}}}async function _(e){return{windowMs:6e5,ingested_total:(await u.db.select().from(d.U3).where((0,l.gt)(d.U3.timestamp,e-6e5))).length,duplicates_total:0,dlq_total:0,p95_ms:0}}async function c(e){var t;let o;let r=Date.now(),s=(t=await e.json().catch(()=>({})))&&"object"==typeof t?{fromSlot:"number"==typeof t.fromSlot?t.fromSlot:void 0,limit:"number"==typeof t.limit?t.limit:void 0,dryRun:"boolean"==typeof t.dryRun&&t.dryRun,scope:"string"==typeof t.scope?t.scope:void 0}:{};if("creators"===s.scope)o=await h(s.dryRun||!1);else{let e=await _(r);o={params:s,...e},console.log(JSON.stringify({msg:"replay_request",window_ms:e.windowMs,params:s,metrics:e}))}return i.NextResponse.json(o)}async function g(e){let{searchParams:t}=new URL(e.url),o=t.get("scope"),r="true"===t.get("dry-run");if("creators"===o){let e=await h(r);return console.log(JSON.stringify({msg:"replay_creators",dryRun:r,result:e.result})),i.NextResponse.json(e)}{let e=Date.now(),t=await _(e);return console.log(JSON.stringify({msg:"replay_metrics",window_ms:t.windowMs,metrics:t})),i.NextResponse.json(t)}}async function h(e){let t=Date.now(),o=[];o.push(`[${new Date().toISOString()}] Starting creators replay operation`),o.push(`Dry-run: ${e}`);try{let[r,s,a]=await Promise.all([u.db.select().from(d.E7),u.db.select().from(d.OW),u.db.select().from(d.U3)]);o.push(`[${new Date().toISOString()}] Found ${r.length} hosts, ${s.length} stories, ${a.length} events`);let n=new Map;for(let e of r){let t=s.filter(t=>t.host_id===e.id),r=0,i=new Set,l=0;for(let e of t)for(let t of a.filter(t=>t.story_id===e.id))"tip"===t.type?(r+=Number(t.amount||0),i.add(t.signer)):"share"===t.type&&(l+=1);n.set(e.id,{host_id:e.id,host_name:e.name,total_tip_value_sol:r,unique_supporters:i.size,share_count:l,stories_count:t.length}),o.push(`[${new Date().toISOString()}] ${e.name}: ${r.toFixed(2)} SOL, ${i.size} supporters, ${l} shares, ${t.length} stories`)}let i=s.length,l=r.length,_=new Map,c=0;for(let e of a){let t=`${e.tx_signature}-${e.type}`,o=_.get(t)||0;o>0&&c++,_.set(t,o+1)}let g=c,h=Date.now()-t;if(e)o.push(`[${new Date().toISOString()}] Dry-run mode: skipping database update`);else{o.push(`[${new Date().toISOString()}] Updating host_metrics table...`);let e=await p();o.push(`[${new Date().toISOString()}] Host metrics refreshed: ingested_total=${e.ingested_total}, duplicates_total=${e.duplicates_total}, overview_latency_ms=${e.overview_latency_ms}`)}let y=Array.from(n.values()),m=Date.now()-t;return o.push(`[${new Date().toISOString()}] Replay completed in ${m}ms`),{success:!0,scope:"creators",dryRun:e,result:{ingested_total:i,duplicates_total:g,overview_latency_ms:h,creators_processed:l,details:y},logs:o}}catch(r){return o.push(`[${new Date().toISOString()}] âœ— Error: ${r instanceof Error?r.message:"Unknown error"}`),{success:!1,scope:"creators",dryRun:e,result:{ingested_total:0,duplicates_total:0,overview_latency_ms:Date.now()-t,creators_processed:0},logs:o}}}let y=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/ops/replay/route",pathname:"/api/ops/replay",filename:"route",bundlePath:"app/api/ops/replay/route"},resolvedPagePath:"/Users/lvxuan/github/TipConnect/app/api/ops/replay/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:w}=y,v="/api/ops/replay/route";function S(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},6357:(e,t,o)=>{o.d(t,{E7:()=>p,OW:()=>d,U3:()=>_,zc:()=>c});var r=o(989),s=o(7533),a=o(2582),n=o(3755),i=o(2723),l=o(8873),u=o(3836);let d=(0,r.af)("stories",{id:(0,s.L7)("id",{length:64}).primaryKey(),title:(0,a.fL)("title").notNull(),summary:(0,a.fL)("summary").default(""),host_id:(0,s.L7)("host_id",{length:64}).notNull(),created_at:(0,n.AB)("created_at",{withTimezone:!0}).defaultNow()}),p=(0,r.af)("hosts",{id:(0,s.L7)("id",{length:64}).primaryKey(),name:(0,a.fL)("name").notNull(),web2_links:(0,a.fL)("web2_links").default("[]"),created_at:(0,n.AB)("created_at",{withTimezone:!0}).defaultNow()}),_=(0,r.af)("events",{id:(0,s.L7)("id",{length:72}).primaryKey().$defaultFn(()=>crypto.randomUUID()),type:(0,s.L7)("type",{length:16}).notNull(),signer:(0,s.L7)("signer",{length:128}).notNull(),receiver:(0,s.L7)("receiver",{length:128}).notNull(),amount:(0,i.uR)("amount",{precision:18,scale:9}).default("0"),tx_signature:(0,s.L7)("tx_signature",{length:128}).notNull(),story_id:(0,s.L7)("story_id",{length:64}),timestamp:(0,l.Kv)("timestamp",{mode:"number"}).notNull()},e=>({byTxType:(0,u.o9)("uniq_tx_type").on(e.tx_signature,e.type),byStory:(0,u.Kz)("idx_story").on(e.story_id)})),c=(0,r.af)("host_metrics",{host_id:(0,s.L7)("host_id",{length:64}).primaryKey(),total_tip_value_sol:(0,i.uR)("total_tip_value_sol",{precision:18,scale:9}).default("0"),unique_supporters:(0,i.uR)("unique_supporters",{precision:10,scale:0}).default("0"),share_count:(0,i.uR)("share_count",{precision:10,scale:0}).default("0"),stories_count:(0,i.uR)("stories_count",{precision:10,scale:0}).default("0"),updated_at:(0,n.AB)("updated_at",{withTimezone:!0}).defaultNow()});(0,r.af)("story_metrics_daily",{id:(0,s.L7)("id",{length:72}).primaryKey().$defaultFn(()=>crypto.randomUUID()),story_id:(0,s.L7)("story_id",{length:64}).notNull(),date:(0,n.AB)("date",{withTimezone:!0}).notNull(),total_tip_value_sol:(0,i.uR)("total_tip_value_sol",{precision:18,scale:9}).default("0"),unique_supporters:(0,i.uR)("unique_supporters",{precision:10,scale:0}).default("0"),share_count:(0,i.uR)("share_count",{precision:10,scale:0}).default("0"),created_at:(0,n.AB)("created_at",{withTimezone:!0}).defaultNow()},e=>({byStoryDate:(0,u.o9)("uniq_story_date").on(e.story_id,e.date),byStory:(0,u.Kz)("idx_story").on(e.story_id),byDate:(0,u.Kz)("idx_date").on(e.date)}))},7312:(e,t,o)=>{o.d(t,{db:()=>l});var r=o(7136),s=o(7910);let a=process.env.DATABASE_URL||"",n=a.includes("channel_binding=")?a:a+(a.includes("?")?"&":"?")+"channel_binding=disable";if(!n)throw Error("DATABASE_URL is not set");let i=(0,s.qn)(n),l=(0,r.tS)(i)}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),r=t.X(0,[764,914],()=>o(920));module.exports=r})();